name: CI/CD Build

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: update submodules
      uses: textbook/git-checkout-submodule-action@master

    - name: Create Build Environment
      run: cmake -E make_directory ${{github.workspace}}/build

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install libcurl4-openssl-dev libz-dev libssl-dev automake libtool qtbase5-dev qttools5-dev

    - name: Sonarcloud build-wrapper
      working-directory: /opt
      shell: bash
      run: wget https://sonarcloud.io/static/cpp/build-wrapper-linux-x86.zip && unzip build-wrapper-linux-x86.zip

    - name: Configure CMake
      # Use a bash shell so we can use the same syntax for environment variable
      # access regardless of the host operating system
      shell: bash
      working-directory: ${{github.workspace}}/build
      # Note the current convention is to use the -S and -B options here to specify source 
      # and build directories, but this is only available with CMake 3.13 and higher.  
      # The CMake binaries on the Github Actions machines are (as of this writing) 3.12
      run: cmake $GITHUB_WORKSPACE -DCMAKE_BUILD_TYPE=$BUILD_TYPE

    - name: Build
      working-directory: ${{github.workspace}}/build
      shell: bash
      # Execute the build.  You can specify a specific target with "--target <NAME>"
      run: cmake --build . --config $BUILD_TYPE
      
    - name: Sonarcloud scanner
      working-directory: /opt
      shell: bash
      run: wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.6.0.2311-linux.zip && 
        unzip sonar-scanner-cli-4.6.0.2311-linux.zip && 
        mv sonar-scanner-4.6.0.2311-linux sonar-scanner-cli
        
    - name: Make
      working-directory: /opt
      run: /opt/build-wrapper-linux-x86/build-wrapper-linux-x86-64 --out-dir /tmp/sonarcloud-wrapper-output make
      
    - name: Run sonar-scanner
      working-directory: ${{github.workspace}}
      shell: bash
      run: >-
        /sbw/sonar-scanner-cli/bin/sonar-scanner
        -D sonar.cfamily.threads=2
        -D sonar.login="${{ secrets.SONAR_TOKEN }}"
        -D sonar.host.url="https://sonarcloud.io/"
        
        -D sonar.exclusions="${{github.workspace}}/qt/translations/"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
